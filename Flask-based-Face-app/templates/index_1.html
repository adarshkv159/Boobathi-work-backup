<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Face Recognition Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Simple styling for demonstration -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 0;
        }
        header {
            background: #3f51b5;
            color: #fff;
            padding: 18px 30px;
            font-size: 1.7em;
            letter-spacing: 2px;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: #fff;
            box-shadow: 0 0 18px #bbb;
            padding: 30px;
            border-radius: 12px;
        }
        .status-bar {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 18px;
            font-weight: bold;
        }
        .status-info { background: #e3eaff; color: #222; }
        .status-success { background: #e7ffe7; color: #1b5e20; }
        .status-warning { background: #fffbe0; color: #857300; }
        .status-error { background: #ffe5e5; color: #b71c1c; }
        .row { display: flex; gap: 24px; }
        .column { flex: 1; }
        label { font-weight: bold; }
        input, select, button {
            margin: 7px 0 16px 0;
            padding: 7px 12px;
            font-size: 1em;
            border-radius: 6px;
            border: 1px solid #bbb;
        }
        button {
            background: #3f51b5;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-right: 8px;
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        .face-list { list-style: none; padding: 0; }
        .face-list li {
            background: #f0f0f0;
            margin: 6px 0;
            padding: 7px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .face-list button {
            background: #c62828;
            color: #fff;
            padding: 4px 10px;
            font-size: 0.95em;
        }
        .camera-frame {
            width: 100%;
            max-width: 360px;
            border-radius: 8px;
            border: 1px solid #aaa;
            display: block;
            margin-bottom: 10px;
        }
        .samples-row { display: flex; gap: 10px; margin-top: 12px; }
        .sample-img-container {
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: border 0.2s;
            box-sizing: border-box;
        }
        .sample-img-container.selected {
            border: 2px solid #3f51b5;
            background: #e3eaff;
        }
        .sample-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
        }
        .device-selects { display: flex; gap: 14px; }
        .footer {
            text-align: center;
            margin-top: 45px;
            color: #888;
            font-size: 0.97em;
        }
    </style>
</head>
<body>
<header>
    Face Recognition Control Panel
</header>
<div class="container">
    <div id="status" class="status-bar status-info">Initializing...</div>
    <div class="device-selects">
        <div>
            <label for="videoDeviceSelect">Camera:</label>
            <select id="videoDeviceSelect"></select>
        </div>
        <div>
            <label for="audioDeviceSelect">Audio Output:</label>
            <select id="audioDeviceSelect"></select>
        </div>
        <div style="flex: 1; display:flex; align-items:flex-end; gap:10px;">
            <button id="startCameraBtn">Start Camera</button>
            <button id="stopCameraBtn" disabled>Stop Camera</button>
            <button id="resetSystemBtn">Reset System</button>
            <button id="loadModelsBtn">Reload Models</button>
        </div>
    </div>
    <div class="row">
        <div class="column" style="max-width: 380px;">
            <img id="cameraFrame" class="camera-frame" src="" alt="Camera feed"/>
            <div id="faceDetectionInfo"></div>
            <div id="captureSamplesSection" style="display:none;">
                <div><b>Select the best face sample:</b></div>
                <div class="samples-row" id="samplesRow"></div>
                <button id="cancelSampleBtn" style="margin-top:12px;">Cancel</button>
            </div>
        </div>
        <div class="column">
            <form id="addFaceForm" autocomplete="off">
                <label for="addFaceName">Add New Face:</label><br>
                <input id="addFaceName" type="text" placeholder="Enter name" required>
                <button id="addFaceBtn" type="submit">Add Face</button>
            </form>
            <form id="deleteFaceForm" autocomplete="off">
                <label for="deleteFaceName">Delete Face by Name:</label><br>
                <input id="deleteFaceName" type="text" placeholder="Enter name" required>
                <button id="deleteFaceBtn" type="submit" style="background:#c62828;">Delete</button>
            </form>
            <hr>
            <div>
                <strong>Known Faces (<span id="totalFaces">0</span>):</strong>
                <ul class="face-list" id="faceList"></ul>
            </div>
        </div>
    </div>
</div>
<div class="footer">
    Enhanced Face Recognition for i.MX8M Plus &middot; <a href="https://github.com/" target="_blank">GitHub</a>
</div>
<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();

let samples = [];
let selectedSampleId = null;
let capturingSamples = false;

// --- Status Bar ---
function setStatus(message, type="info") {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status-bar status-${type}`;
}

// --- Camera Frame ---
const cameraFrame = document.getElementById('cameraFrame');
const faceDetectionInfo = document.getElementById('faceDetectionInfo');

socket.on('video_frame', data => {
    cameraFrame.src = "data:image/jpeg;base64," + data.frame;
    faceDetectionInfo.textContent = data.capturing_samples ? "" :
        (data.faces_detected > 0 ?
            `${data.faces_detected} face(s) detected` : "No face detected");
    capturingSamples = data.capturing_samples;
});

// --- Status Updates ---
socket.on('status_update', (data) => {
    setStatus(data.message, data.type || "info");
});

// --- List of Faces ---
function updateFaceList(names) {
    const list = document.getElementById('faceList');
    list.innerHTML = '';
    for (const name of names) {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${name}</span>
            <button onclick="quickDeleteFace('${name}')">Delete</button>
        `;
        list.appendChild(li);
    }
}

function refreshFaceList() {
    fetch('/api/names')
        .then(res => res.json())
        .then(data => {
            updateFaceList(data.names);
            document.getElementById('totalFaces').textContent = data.total_faces;
        });
}
function quickDeleteFace(name) {
    if (confirm(`Delete face: ${name}?`)) {
        socket.emit('quick_delete', {name});
        setTimeout(refreshFaceList, 600);
    }
}
window.quickDeleteFace = quickDeleteFace;

// --- Add Face Form ---
document.getElementById('addFaceForm').addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('addFaceName').value.trim();
    if (!name) return;
    socket.emit('manual_add_face', {name});
    document.getElementById('addFaceName').value = '';
});

// --- Delete Face Form ---
document.getElementById('deleteFaceForm').addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('deleteFaceName').value.trim();
    if (!name) return;
    socket.emit('manual_delete_face', {name});
    setTimeout(refreshFaceList, 700);
    document.getElementById('deleteFaceName').value = '';
});

// --- Camera Controls ---
const startCameraBtn = document.getElementById('startCameraBtn');
const stopCameraBtn = document.getElementById('stopCameraBtn');
startCameraBtn.onclick = () => {
    socket.emit('start_camera');
    startCameraBtn.disabled = true;
    stopCameraBtn.disabled = false;
};
stopCameraBtn.onclick = () => {
    socket.emit('stop_camera');
    startCameraBtn.disabled = false;
    stopCameraBtn.disabled = true;
};

// --- Reset System ---
document.getElementById('resetSystemBtn').onclick = () => {
    socket.emit('reset_system');
    setTimeout(refreshFaceList, 500);
};

// --- Reload Models ---
document.getElementById('loadModelsBtn').onclick = () => {
    socket.emit('load_models');
};

// --- Device Selects ---
function populateDeviceSelect(selectElem, devices, currentId) {
    selectElem.innerHTML = '';
    for (const dev of devices) {
        const opt = document.createElement('option');
        opt.value = dev.id;
        opt.textContent = dev.display;
        if (dev.id == currentId) opt.selected = true;
        selectElem.appendChild(opt);
    }
}
function updateDevicesUI() {
    fetch('/api/devices')
        .then(res => res.json())
        .then(data => {
            populateDeviceSelect(
                document.getElementById('videoDeviceSelect'),
                data.video_devices
            );
            populateDeviceSelect(
                document.getElementById('audioDeviceSelect'),
                data.audio_output_devices
            );
        });
}
document.getElementById('videoDeviceSelect').onchange = e => {
    socket.emit('update_device', {type:'video', id: parseInt(e.target.value)});
};
document.getElementById('audioDeviceSelect').onchange = e => {
    socket.emit('update_device', {type:'audio_output', id: e.target.value});
};

// --- Face Capture Samples ---
socket.on('sample_captured', function(data) {
    showSamplesSection();
    addSample(data.sample, data.count, data.total);
});
socket.on('samples_ready', function(data) {
    showSamplesSection();
    samples = data.samples;
    renderSamples();
});
socket.on('samples_cleared', function() {
    hideSamplesSection();
    samples = [];
    selectedSampleId = null;
});
function showSamplesSection() {
    document.getElementById('captureSamplesSection').style.display = '';
    stopCameraBtn.disabled = true;
}
function hideSamplesSection() {
    document.getElementById('captureSamplesSection').style.display = 'none';
    stopCameraBtn.disabled = false;
    document.getElementById('samplesRow').innerHTML = '';
}
function addSample(sample) {
    samples.push(sample);
    renderSamples();
}
function renderSamples() {
    const row = document.getElementById('samplesRow');
    row.innerHTML = '';
    for (const sample of samples) {
        const div = document.createElement('div');
        div.className = 'sample-img-container' + (sample.id === selectedSampleId ? ' selected' : '');
        div.onclick = () => selectSample(sample.id);
        div.innerHTML = `<img class="sample-img" src="data:image/jpeg;base64,${sample.image}" alt="Sample"/>`;
        row.appendChild(div);
    }
}
function selectSample(sampleId) {
    selectedSampleId = sampleId;
    renderSamples();
    socket.emit('select_face_sample', {sample_id: sampleId});
}
document.getElementById('cancelSampleBtn').onclick = function() {
    socket.emit('cancel_face_capture');
    hideSamplesSection();
};

// --- Face List Updates ---
socket.on('face_added', function(data){
    setTimeout(refreshFaceList, 700);
});
socket.on('face_deleted', function(data){
    setTimeout(refreshFaceList, 500);
});
socket.on('face_list_update', function(data){
    updateFaceList(data.names);
    document.getElementById('totalFaces').textContent = data.total_faces;
});
socket.on('system_reset', function(){
    refreshFaceList();
});

// --- On Connect ---
socket.on('connect', function() {
    fetch('/api/status').then(res => res.json()).then(data => {
        setStatus(data.status_message, data.status_type || 'info');
        if (data.running) {
            startCameraBtn.disabled = true;
            stopCameraBtn.disabled = false;
        } else {
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
        }
    });
    updateDevicesUI();
    refreshFaceList();
});

// --- Initial Load ---
window.onload = function() {
    updateDevicesUI();
    refreshFaceList();
};
</script>
</body>
</html>
